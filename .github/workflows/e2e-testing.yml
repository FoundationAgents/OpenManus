name: End-to-End Testing Pipeline

on:
  push:
    branches: [main, e2e-testing-ci-pytest-ui-guardian-sandbox-integration]
  pull_request:
    branches: [main]
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'

env:
  PYTHON_VERSION: "3.12"
  QT_QPA_PLATFORM: "offscreen"

jobs:
  e2e-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.11", "3.12"]
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Cache pip dependencies
      uses: actions/cache@v4
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xfixes0 libxcb-xinerama0 libxcb-xkb1 libxkbcommon-x11-0
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip setuptools wheel
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-qt pytest-cov pytest-timeout pytest-xdist
        pip install PyQt6 PyQt6-WebEngine
    
    - name: Run E2E workflow tests
      run: |
        python -m pytest tests/test_e2e_workflows.py -v --tb=short
      env:
        QT_QPA_PLATFORM: offscreen
    
    - name: Run smoke tests
      run: |
        python -m pytest tests/test_smoke_tests.py -v --tb=short -m smoke
      env:
        QT_QPA_PLATFORM: offscreen
    
    - name: Run integration tests
      run: |
        python -m pytest tests/test_integration_e2e.py -v --tb=short -m integration
      env:
        QT_QPA_PLATFORM: offscreen
    
    - name: Generate E2E coverage report
      run: |
        python -m pytest tests/test_e2e_workflows.py tests/test_smoke_tests.py tests/test_integration_e2e.py -v --cov=app --cov-report=xml --cov-report=html --cov-report=term-missing
      env:
        QT_QPA_PLATFORM: offscreen
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: e2e
        name: e2e-coverage-${{ matrix.python-version }}
        fail_ci_if_error: false
    
    - name: Archive E2E test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: e2e-results-${{ matrix.python-version }}
        path: |
          htmlcov/
          tests/pytest.log

  ui-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: Install system dependencies for UI tests
      run: |
        sudo apt-get update
        sudo apt-get install -y libxkbcommon-x11-0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-xfixes0 libxcb-xinerama0 libxcb-xkb1 libxkbcommon-x11-0 xvfb
    
    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-qt pytest-cov PyQt6 PyQt6-WebEngine
    
    - name: Run UI tests with xvfb
      run: |
        xvfb-run -a python -m pytest tests/ -v -m qt --tb=short
      env:
        QT_QPA_PLATFORM: offscreen
    
    - name: Archive UI test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-test-results
        path: tests/pytest.log

  security-validation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio bandit safety
    
    - name: Run security tests
      run: |
        python -m pytest tests/test_guardian_validation.py tests/test_permissions.py -v --tb=short
    
    - name: Run bandit security scan
      run: |
        bandit -r app/ -ll -f json -o bandit-report.json || true
    
    - name: Check for known vulnerabilities
      run: |
        safety check --json > safety-report.json || true
    
    - name: Archive security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json

  performance-validation:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-benchmark psutil memory-profiler
    
    - name: Run performance tests
      run: |
        python -m pytest tests/ -v --benchmark-only 2>&1 | tee performance-results.txt || true
    
    - name: Archive performance results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-results
        path: performance-results.txt

  backup-recovery-tests:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio
    
    - name: Run backup/restore tests
      run: |
        python -m pytest tests/test_backup_manager.py tests/test_e2e_workflows.py::TestEndToEndWorkflowIntegration::test_workflow_recovery_from_agent_failure -v --tb=short
    
    - name: Archive backup test results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: backup-test-results
        path: tests/pytest.log

  results-summary:
    runs-on: ubuntu-latest
    needs: [e2e-tests, ui-tests, security-validation, performance-validation, backup-recovery-tests]
    if: always()
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
    
    - name: Generate test summary
      run: |
        echo "# E2E Testing Pipeline Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Results" >> $GITHUB_STEP_SUMMARY
        echo "- E2E Tests: ${{ needs.e2e-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- UI Tests: ${{ needs.ui-tests.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Security Validation: ${{ needs.security-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Performance Validation: ${{ needs.performance-validation.result }}" >> $GITHUB_STEP_SUMMARY
        echo "- Backup/Recovery Tests: ${{ needs.backup-recovery-tests.result }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Notify on completion
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ All E2E tests passed successfully!"
        else
          echo "❌ Some tests failed. Check artifacts for details."
        fi

  regression-check:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio pytest-cov
    
    - name: Run regression tests
      run: |
        python -m pytest tests/test_e2e_workflows.py tests/test_smoke_tests.py -v --tb=short --cov=app --cov-report=term-missing
